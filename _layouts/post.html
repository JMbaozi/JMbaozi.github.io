<!DOCTYPE html>
<html>
{% include post-head.html %}
<body>
  <!--
  <div class="alert-danger" role="alert">
    你的浏览器实在太太太旧了，放学别走，升级完浏览器再说！
    <a target="_blank" class="alert-link" href="http://browsehappy.com">立即升级</a>
  </div>
  -->
  <input id="nm-switch" type="hidden" value="{{ site.nightMode }}"> {% include header.html %}

  <header
    class="g-banner post-header {{ site.postPatterns | prepend: 'post-pattern-' }} {{ site.theme-color | prepend: 'bgcolor-' }} {% unless page.cover %}post-no-cover{% endunless %}"
    data-theme="{{ site.theme-color }}"
  >
    <div class="post-wrapper">
      <div class="post-tags">
        {% if page.tags.size > 0 %}
          {% for tag in page.tags  %}
            <a href="{{ "/tags.html#" | append: tag | relative_url }}" class="post-tag">{{ tag }}</a>
          {% endfor %}
        {% endif %}
      </div>
      <h1>{{ page.title }}</h1>
      <div class="post-meta">
        <span class="post-meta-item"><i class="iconfont icon-author"></i>{% if page.author %}{{ page.author }}{% else %}{{ site.author }}{% endif %}</span>
        <time class="post-meta-item" datetime="{{ page.date | date:"%y-%m-%d" }}"><i class="iconfont icon-date"></i>{{ page.date | date_to_string }}</time>
      </div>
    </div>
    {% if page.cover %}
    <div class="filter"></div>
      <div class="post-cover" style="background: url('{{ page.cover | relative_url }}') center no-repeat; background-size: cover;"></div>
    {% endif %}
  </header>
  <div class="post-content visible">
    {% if page.subtitle %}
    <h2 class="post-subtitle toc-ignore">{{ page.subtitle }}</h2>
    {% endif %}
	<!-- 在正文开头添加网易云音乐插件 -->
    {% if page.music-id %}
      {% include cloud-music.html %}
    {% endif %} 

    <div class="post-body">
      <article class="markdown-body">
        {{ page.content }}
      </article>
    </div>

    {% if site.social-share %}
    <div class="social-share-wrapper toc-ignore">
      <div class="social-share"></div>
    </div>
    {% endif %}
  </div>

  <section class="author-detail">
    <section class="post-footer-item author-card">
      <div class="avatar">
        <img src="{{ site.avatar | relative_url }}" alt="">
      </div>
      <div class="author-name" rel="author">{{ site.author }}</div>
      <div class="bio">
        <p>{{ site.bio }}</p>
      </div>
      {% if site.sns.size > 0 %}
      <ul class="sns-links">
        {% for s in site.sns %}
        <li>
          <a href="{{ s[1] }}" target="_blank">
                    <i class="iconfont icon-{{ s[0] }}"></i>
                </a>
        </li>
        {% endfor %}
      </ul>
      {% endif %}
    </section>
    <section class="post-footer-item read-next">
      {% if page.next.url %}
      <div class="read-next-item">
        <a href="{{ page.next.url | relative_url }}" class="read-next-link"></a>
        <section>
          <span>{{ page.next.title }}</span>
          <p>{{ page.next.excerpt | strip_html | strip_newlines | truncate: 60}}</p>
        </section>
        {% if page.next.cover %}
        <div class="filter"></div>
        <img src="{{ page.next.cover | relative_url }}" alt="">
        {% endif %}
     </div>
      {% endif %}

      {% if page.previous.url %}
      <div class="read-next-item">
        <a href="{{ page.previous.url | relative_url }}" class="read-next-link"></a>
          <section>
            <span>{{ page.previous.title }}</span>
            <p>{{ page.previous.excerpt | strip_html | strip_newlines | truncate: 60}}</p>
          </section>
          {% if page.previous.cover %}
          <div class="filter"></div>
          <img src="{{ page.previous.cover | relative_url }}" alt="">
          {% endif %}
      </div>
      {% endif %}
    </section>
    {% if site.comments.disqus %}
    <section class="post-footer-item comment">
        <div id="disqus_thread"></div>
    </section>
    {% endif %}
  </section>
  <!--文章评论-->
  <section class="tags-content" style="margin-top: 0px">
      <ul class="tags-list" style="list-style-type: none;padding: auto;">
		  <h1></h1>
	  {% include comments.html %}	
      </ul>
  </section>
  {% include footerpost.html %}

  <script src="{{ "/assets/js/social-share.min.js" | relative_url }}"></script>
  <script>
    socialShare('.social-share', {
      sites: [
        {% for i in site.social-share-items %}
          '{{ i }}'
          {% if forloop.last == false %},
          {% endif %}
        {% endfor %}
      ],
      wechatQrcodeTitle: "分享到微信朋友圈",
      wechatQrcodeHelper: '<p>扫码后点击右上角</p><p>将本文分享至朋友圈</p>'
    });
  </script>

  {% if site.comments.disqus %}
  <script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = '{{ site.comments.disqus_url }}';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  {% endif %}

  <script src="{{ "/assets/js/prism.js" | relative_url }}"></script>
  <script src="{{ "/assets/js/index.min.js" | relative_url }}"></script>
{% include open-embed.html %}
<!--<script src="https://cdn.jsdelivr.net/gh/TRHX/CDN-for-itrhx.com@2.0.2/js/instantclick-1.2.2.js" type="module"></script>-->
  <!--goTop按钮-->
  <div id="backtop">
    <a href="javascript:void(0)"><img src="/assets/img/goTop.png" border="0"></a>
  </div>
  <script>
  document.querySelector('#backtop a').addEventListener('click', function(e){
    e.preventDefault();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
  </script>

  <!-- 目录按钮（移动端） -->
  <div id="toc-toggle">目录</div>

  <!-- 右侧目录（桌面端固定） -->
  <aside class="post-toc">
    <h2>目录</h2>
    <!-- TOC 会自动生成 -->
  </aside>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const tocAside = document.querySelector(".post-toc");
    const tocToggle = document.getElementById("toc-toggle");
    
    // 自动生成 TOC：只抓正文 .post-body 内 H1~H6，排除 toc-ignore
    function generateTOC() {
      const headings = document.querySelectorAll('.post-body h1, .post-body h2, .post-body h3, .post-body h4, .post-body h5, .post-body h6:not(.toc-ignore)');
      const tocUL = document.createElement('ul');
      headings.forEach(heading => {
        if(!heading.id){
          heading.id = heading.textContent.trim().replace(/\s+/g,'-').toLowerCase();
        }
        const li = document.createElement('li');
        li.dataset.level = heading.tagName.substring(1); // H1=1,H2=2,...
        const a = document.createElement('a');
        a.href = '#' + heading.id;
        a.textContent = heading.textContent;
        li.appendChild(a);
        tocUL.appendChild(li);
      });
      tocAside.appendChild(tocUL);
    }

    generateTOC();
    const tocLinks = tocAside.querySelectorAll('a');

    // 折叠功能
    tocAside.querySelectorAll('li').forEach(li => {
      const nextUL = li.querySelector('ul');
      if(nextUL){
        li.classList.add('collapsed');
        const link = li.querySelector('a');
        link.classList.add('toggle');
        link.addEventListener('click', function(e){
          if(li.classList.contains('collapsed')){
            li.classList.remove('collapsed');
            li.classList.add('expanded');
          } else {
            li.classList.remove('expanded');
            li.classList.add('collapsed');
          }
        });
      }
    });

    // 高亮逻辑
    const headings = document.querySelectorAll('.post-body h1:not(.toc-ignore), .post-body h2:not(.toc-ignore), .post-body h3:not(.toc-ignore), .post-body h4:not(.toc-ignore), .post-body h5:not(.toc-ignore), .post-body h6:not(.toc-ignore)');

    function onScroll() {
      let current = headings[0];
      headings.forEach(h => {
        if(h.getBoundingClientRect().top < 100) current = h; // 阈值可调
      });

      tocLinks.forEach(link => link.classList.remove('active'));
      const activeLink = tocAside.querySelector(`a[href="#${current.id}"]`);
      if(activeLink) activeLink.classList.add('active');

      // 自动展开父 li
      tocAside.querySelectorAll('li').forEach(li => {
        if(li.contains(activeLink)){
          let parent = li.parentElement.closest('li');
          while(parent){
            parent.classList.remove('collapsed');
            parent.classList.add('expanded');
            parent = parent.parentElement.closest('li');
          }
        }
      });
    }

    document.addEventListener('scroll', onScroll);
    onScroll();

    // 点击平滑滚动 + 高亮
    tocLinks.forEach(link => {
      link.addEventListener('click', function(e){
        const targetId = this.getAttribute('href').substring(1);
        const target = document.getElementById(targetId);
        if(target){
          e.preventDefault();
          target.scrollIntoView({behavior:'smooth', block:'start'});
          onScroll(); // 点击立即刷新高亮
          if(window.innerWidth <= 900){
            tocAside.classList.remove('show');
          }
        }
      });
    });

    // 移动端点击按钮切换显示
    tocToggle.addEventListener('click', function(e){
      tocAside.classList.toggle('show');
    });

    // 移动端点击页面其他地方收起 TOC
    document.addEventListener('click', function(e){
      const isClickInsideTOC = tocAside.contains(e.target);
      const isClickOnButton = tocToggle.contains(e.target);
      if(!isClickInsideTOC && !isClickOnButton){
        tocAside.classList.remove('show');
      }
    });
  });
  </script>
</body>

</html>
